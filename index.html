<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Wheel of Life Assessment</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- html2canvas (用於網頁截圖) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Roboto:wght@500;700&display=swap');

        body {
            font-family: 'Roboto', 'Noto Sans TC', sans-serif;
            background-color: #f8fafc;
            color: #334155;
            overflow-x: hidden; 
        }

        /* === 滑桿樣式 === */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
            margin-top: 8px;
            padding: 5px 0; 
        }
        
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 6px;
            cursor: pointer;
            background: #cbd5e1;
            border-radius: 4px;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 24px;
            width: 24px;
            border-radius: 50%;
            background: #4f46e5;
            border: 3px solid #ffffff;
            cursor: pointer;
            margin-top: -9px;
            box-shadow: 0 2px 5px rgba(79, 70, 229, 0.4);
            transition: transform 0.1s ease;
        }

        input[type=range]::-webkit-slider-thumb:hover,
        input[type=range]::-webkit-slider-thumb:active {
            transform: scale(1.15);
        }

        /* 讀取中的動畫效果 */
        .loading {
            opacity: 0.7;
            pointer-events: none;
            cursor: wait;
        }

        /* 輸入框樣式 */
        .custom-input {
            border: 1px solid #cbd5e1;
            transition: all 0.3s;
        }
        .custom-input:focus {
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
    </style>
</head>
<!-- 
    修正點：
    將 body 的 flex 設定改為 flex-col (垂直排列)，
    並加上 items-center (水平置中)。
    這樣主卡片和下方的按鈕就會垂直堆疊，不會並排顯示。
-->
<body class="min-h-screen py-6 px-3 md:py-10 md:px-6 flex flex-col items-center justify-start">

    <!-- 主卡片 (id="capture-area" 是截圖範圍) -->
    <div id="capture-area" class="bg-white w-full max-w-[1100px] rounded-2xl md:rounded-3xl shadow-lg md:shadow-xl overflow-hidden p-5 md:p-12 border border-gray-100 relative">
        
        <!-- 標題區 -->
        <header class="text-center mb-6 md:mb-10">
          <h1 class="text-2xl md:text-5xl font-bold text-indigo-900 mb-3 md:mb-5 tracking-tight">Wheel of Life 生命之輪</h1>

          <p class="text-gray-500 text-xs md:text-base leading-relaxed max-w-3xl mx-auto px-2">
            生命之輪代表了組成生命的各個面向，幫助我們更宏觀的觀察此刻的生命狀態。
          </p>
            
          <p class="text-gray-500 text-xs md:text-base leading-relaxed max-w-3xl mx-auto px-2">
            你對於此時此刻的生命各個面向的滿足程度在哪裡呢？
          </p>
          
          <br> <span class="text-xs text-indigo-500 italic mt-2 block">
            "請依照滿意程度調整下方滑桿，越高分代表越滿意，圖表將即時描繪出生命之輪的圖形。"
          </span>
        </header>

        <!-- 圖表區 -->
        <div class="flex justify-center mb-8 md:mb-16">
            <div id="chart-wrapper" class="relative w-full md:w-[80%] max-w-[800px] aspect-square">
                <canvas id="lifeWheelChart"></canvas>
            </div>
        </div>

        <!-- 評分控制區 (包含滑桿) -->
        <div class="bg-[#f8fafc] rounded-xl md:rounded-2xl p-5 md:p-8 border border-slate-100 mb-8">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 md:mb-8 border-b border-slate-200 pb-4 gap-2">
                <h3 class="font-bold text-lg md:text-xl text-indigo-900 flex items-center gap-3">
                    <span class="w-1.5 h-6 bg-indigo-600 rounded-full inline-block"></span>
                    評分 (Score Your Areas)
                </h3>
                <span class="text-xs text-gray-400 font-medium">1 = 非常不滿意 | 10 = 非常滿意</span>
            </div>
            
            <div id="inputs-container" class="grid grid-cols-1 md:grid-cols-2 gap-x-16 gap-y-6 md:gap-y-10">
                <!-- JS 自動生成滑桿 -->
            </div>
        </div>

        <!-- 
           【使用者資訊區塊】 
           放在 capture-area 內，會被截圖。
        -->
        <div class="flex flex-col md:flex-row justify-between items-end md:items-center bg-white p-6 rounded-xl border border-slate-100 mb-4">
            
            <!-- 稱呼輸入 -->
            <div class="w-full md:w-1/2 mb-4 md:mb-0">
                <label for="user-name" class="block text-sm font-bold text-indigo-900 mb-2 ml-1">您的稱呼 (Your Name)：</label>
                <input type="text" id="user-name" placeholder="請輸入名字" class="custom-input w-full px-4 py-2 rounded-lg text-slate-700 outline-none bg-slate-50 font-medium text-lg" autocomplete="off">
            </div>

            <!-- 日期顯示 -->
            <div class="text-right">
                <span class="text-xs text-slate-400 block mb-1">Date</span>
                <span id="display-date" class="text-lg font-bold text-slate-600 font-mono tracking-wide"></span>
            </div>
        </div>

        <!-- 頁尾署名 (會被截圖) -->
        <footer class="border-t border-slate-100 pt-4 text-center text-[10px] md:text-xs text-slate-400">
            Design & Developed by <strong class="text-slate-500">KIMU</strong>
        </footer>

    </div>
    <!-- 結束 capture-area -->


    <!-- 
       【操作按鈕區】 
       因為 body 設定了 flex-col，這個區塊會自動排列在 capture-area 的正下方。
    -->
    <div class="w-full max-w-[1100px] mt-8 text-center px-4 pb-12">
        <p class="text-indigo-900 font-medium mb-3 text-sm md:text-base">
            ※此表單不會存檔，填寫完畢後請點擊下方按鈕，下載圖片並回傳給教練
        </p>
        
        <button id="download-btn" onclick="downloadImage()" class="w-full md:w-auto bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3.5 px-12 rounded-full transition-all duration-300 shadow-lg shadow-indigo-200 flex items-center justify-center mx-auto gap-2 active:scale-95">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
            </svg>
            <span id="btn-text">下載生命之輪 (JPG)</span>
        </button>
    </div>


    <script>
        // 設定今天的日期
        const today = new Date();
        const dateString = today.toLocaleDateString('zh-TW', { year: 'numeric', month: '2-digit', day: '2-digit' });
        document.getElementById('display-date').innerText = dateString;

        const categories = [
            { id: 'env', en: 'Physical Environment', cn: '生活環境' },
            { id: 'career', en: 'Career', cn: '事業' },
            { id: 'money', en: 'Money', cn: '財務' },
            { id: 'health', en: 'Health', cn: '健康' },
            { id: 'friends', en: 'Friends & Family', cn: '朋友與家人' },
            { id: 'romance', en: 'Significant Other', cn: '重要他人/戀情' },
            { id: 'growth', en: 'Personal Growth', cn: '個人成長' },
            { id: 'fun', en: 'Fun & Recreation', cn: '娛樂休閒' }
        ];

        const isMobile = window.innerWidth < 768;
        const initialValues = Array(8).fill(1);

        const inputsContainer = document.getElementById('inputs-container');
        categories.forEach((cat, index) => {
            const div = document.createElement('div');
            const currentVal = initialValues[index];
            div.innerHTML = `
                <div class="flex flex-col gap-2 group">
                    <div class="flex justify-between items-start">
                        <div class="flex flex-col">
                            <span class="text-[15px] font-bold text-indigo-900 group-hover:text-indigo-700 transition-colors">${cat.en}</span>
                            <span class="text-xs text-slate-500 mt-0.5">${cat.cn}</span>
                        </div>
                        <span id="val-${cat.id}" class="text-xl font-bold text-indigo-600 font-mono bg-indigo-50 px-2 rounded min-w-[30px] text-center">${currentVal}</span>
                    </div>
                    <input 
                        type="range" 
                        id="${cat.id}" 
                        min="1" 
                        max="10" 
                        step="1" 
                        value="${currentVal}" 
                        oninput="updateChart(${index}, this.value, '${cat.id}')"
                    >
                </div>
            `;
            inputsContainer.appendChild(div);
        });

        const ctx = document.getElementById('lifeWheelChart').getContext('2d');

        const perimeterBorderPlugin = {
            id: 'perimeterBorder',
            afterDatasetsDraw: (chart, args, options) => {
                const { ctx } = chart;
                const meta = chart.getDatasetMeta(0);
                const data = meta.data;

                ctx.save();
                ctx.lineWidth = isMobile ? 2 : 3;
                ctx.strokeStyle = '#1e1b4b'; 
                ctx.lineJoin = 'round';
                ctx.lineCap = 'round';

                ctx.beginPath();
                for (let i = 0; i < data.length; i++) {
                    const el = data[i];
                    const props = el.getProps(['startAngle', 'endAngle', 'outerRadius', 'x', 'y'], true);
                    const center = { x: props.x, y: props.y };

                    ctx.arc(center.x, center.y, props.outerRadius, props.startAngle, props.endAngle);

                    const nextIndex = (i + 1) % data.length;
                    const nextEl = data[nextIndex];
                    const nextProps = nextEl.getProps(['outerRadius'], true);

                    const nextStepX = center.x + Math.cos(props.endAngle) * nextProps.outerRadius;
                    const nextStepY = center.y + Math.sin(props.endAngle) * nextProps.outerRadius;

                    ctx.lineTo(nextStepX, nextStepY);
                }
                ctx.closePath();
                ctx.stroke();
                ctx.restore();
            }
        };

        const wheelChart = new Chart(ctx, {
            type: 'polarArea', 
            data: {
                labels: categories.map(c => [c.en, `(${c.cn})`]), 
                datasets: [{
                    data: initialValues,
                    backgroundColor: 'rgba(165, 180, 252, 0.6)', 
                    borderColor: 'transparent', 
                    borderWidth: 0,
                    hoverBackgroundColor: 'rgba(129, 140, 248, 0.8)',
                    hoverBorderColor: 'transparent'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                layout: { 
                    padding: isMobile ? 10 : 30 
                },
                scales: {
                    r: {
                        min: 0,
                        max: 10,
                        grid: {
                            color: '#e2e8f0',
                            lineWidth: 1,
                            circular: true 
                        },
                        angleLines: {
                            display: true,
                            color: '#e2e8f0',
                            lineWidth: 1
                        },
                        ticks: {
                            display: false,
                            stepSize: 1
                        },
                        pointLabels: {
                            display: true,
                            centerPointLabels: true,
                            font: {
                                size: isMobile ? 10 : 14, 
                                family: "'Roboto', sans-serif",
                                weight: 'bold'
                            },
                            color: '#334155',
                            padding: isMobile ? 10 : 25 
                        }
                    }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(30, 27, 75, 0.9)',
                        padding: 12,
                        cornerRadius: 8,
                        callbacks: {
                            title: tooltipItems => tooltipItems[0].label.replace(',', ' '),
                            label: context => ` Score: ${context.raw} / 10`
                        }
                    }
                }
            },
            plugins: [perimeterBorderPlugin]
        });

        function updateChart(index, value, id) {
            document.getElementById(`val-${id}`).innerText = value;
            wheelChart.data.datasets[0].data[index] = parseInt(value);
            wheelChart.update();
        }

        // === 截圖下載功能 ===
        function downloadImage() {
            const captureElement = document.getElementById('capture-area');
            const btn = document.getElementById('download-btn');
            const btnText = document.getElementById('btn-text');
            const nameInput = document.getElementById('user-name');
            
            // 1. 取得使用者名稱
            let userName = nameInput.value.trim();
            if (!userName) userName = 'My';
            let safeFileName = userName.replace(/[^\w\u4e00-\u9fa5]/g, '_');

            // 2. 變更按鈕狀態
            btn.classList.add('loading');
            const originalText = btnText.innerText;
            btnText.innerText = '處理中...';

            window.scrollTo(0, 0);

            html2canvas(captureElement, {
                scale: 2, 
                useCORS: true, 
                backgroundColor: '#ffffff', 
                scrollY: -window.scrollY
            }).then(canvas => {
                const link = document.createElement('a');
                const date = new Date();
                const dateStr = date.toISOString().split('T')[0];
                
                link.download = `Wheel_of_Life_${safeFileName}_${dateStr}.jpg`;
                
                link.href = canvas.toDataURL('image/jpeg', 0.9);
                link.click();

                btn.classList.remove('loading');
                btnText.innerText = originalText;
            }).catch(err => {
                console.error('Screenshot failed:', err);
                alert('圖片產生失敗，請手動截圖。');
                btn.classList.remove('loading');
                btnText.innerText = originalText;
            });
        }
    </script>
</body>
</html>
